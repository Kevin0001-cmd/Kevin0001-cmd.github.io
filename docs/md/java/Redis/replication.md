

# 前提
首先，我们先了解一下Redis的读写速度和能容纳的键的数量。
Redis的读写很快，根据官网的数据，Redis的读速度是110000次/s，写速度是81000次/s。Redis可以保存2^32个键，在实际的测试中，每个Redis实例纸上可以处理至少2.5亿个键。Redis中的数据结构，每个hash,list,set,sorted list都可以容纳2^32个元素。
所以，在实际使用中Redis的容量一般受限于内存的大小。

Redis虽然拥有高性能，但是在实际生产环境的使用时，单个实例仍然会产生许多问题：
* 内存不足。因为一个Redis的内存是有限的。如果需要的内存空间大于实际的内存空间就不行了。
* 单点故障问题。如果Redis实例挂了，就需要重启或重新配置实例。这需要人工干预，需要一定时间，那么在这段时间内，所有的请求都会穿透数据库。如果时间过长，那么对系统的稳定性有较大的威胁。
* 访问压力大。IO压力和CPU压力都比较大。


# 问题解决
解决上面三个问题的方式有多种，这里只讨论主从复制的方式。

> 拓展知识：AKF理论

简单来说，主从复制即一个主服务器和多个从服务器，从服务器备份了主服务器的全量数据。这样做的好处是如果主服务器故障了，但是从服务器里面包含全量数据，那么请求可以访问从服务器，这样就解决了单点故障的问题。
另外，如果有一主多从，那么请求分散到从服务器上，从而减少主服务器的访问压力。一般是主服务器负责增删改操作，从服务器负责查询操作。因为从服务器一般是不可编辑的，它的数据是从主服务器来的。

# 主从复制过程
1. 客户端向从服务器发送`SLAVEOF IP PORT`命令，从服务器记录`IP`和`PORT`
	> 高版本(7.x)的Redis已将设置从服务器的命令改为`REPLAOF`，而不是`SLAVEOF`
2. 从服务器向主服务器建立套接字，这时主服务器将从服务器看作客户端
3. 从服务器向主服务器发送PING命令，验证是否能连通
4. 从服务器向主服务器发送`AUTH`命令，验证密码，主和从必须都设置密码或都不设置密码才能验证通过
5. 从服务器向主服务器发送自己的端口信息：`REPLCONF listening-port <port>`
6. 执行同步操作，从服务器向主服务器发送`PSYNC`命令。这时，从和主服务器互为客户端。
7. 命令传播，主服务器的数据修改后会发送命令给从服务器以保证数据一致。

## 同步的实现
同步分为两种：完整重同步和部分重同步。

### 完整重同步
完整重同步是指主服务器会将所有的数据同步给从服务器。当第一次进行同步、主从偏移量不同但复制积压缓冲区中找不到缺失的数据时，又或者是主服务器的runid和从服务器的runid不同时，会进行完整重同步。

过程如下：
1. 从服务器向主服务器发送PSYNC命令
2. 主服务器受到命令后执行BGSAVE命令，后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令
3. 当主服务器的BGSAVE执行完毕后，会将生成的RDB文件发送给从服务器。从服务器会接收并载入这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时候的状态
4. 主服务器将缓冲器里面所有的写命令发送给从服务器，从服务器再使用这些写命令，将自己的数据库状态更新至主服务器数据库的当前状态


### 部分重同步
部分重同步是指主服务器将新变动的数据同步给从服务器。

假设从服务器与主服务器断线后，立即重新连接，那么此时进行的就是部分重同步。

过程如下：
1. 从服务器向主服务器发送PSYNC命令，告诉主服务器自己的复制偏移量
2. 主服务器收到从复制偏移量后，检查从复制偏移量之后的数据是否存在复制积压缓冲区中，如果数据在，则主服务器向从服务器发送+CONTINUE回复，表示进行部分重同步模式
3. 主服务器将复制积压缓冲区中从复制偏移量之后的内容发送给从服务器
4. 从服务器收到数据后，就可以回到和主服务器一致的状态


## PSYNC命令的实现
从上面可以知道，同步是由从服务器发送命令`PSYNC`给主服务器开始的。那么`PSYNC`命令具体是如何实现的呢？

主服务器和从服务器都会保存两个值，分别是：复制偏移量，runid。
* 主复制偏移量：主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量的值加上N。从复制偏移量同理。
* runid：服务器的运动ID
此外，主服务器还有一个复制积压缓冲区，用来保存在bgsave期间处理的命令。是一个由主服务器维护的固定长度的先进先出的队列。

* 如果主从服务器是第一次同步，那么就是完整重同步。
* 如果不是第一次同步
	* 主服务器会验证从复制偏移量之后的数据是否在主复制积压缓冲区中
		* 如果在，则将缺少的数据发送给从服务器（CONTINUE）
		* 如果不在，则进行完整重同步（FULLRESYNC）
	* 如果主服务器的runid和从服务器中记录的主服务器runid不同，则进行完整重同步（FULLRESYNC）

# 心跳检测
为了保证主从服务器可以连通，并且命令可以得到处理。从服务器会每秒向主服务器发送命令`REPLCONF ACK <replication-offset>`，以确认两者之间的连接。REPLCONF命令中包含了从服务器的复制偏移量，当主服务器发现从服务器的复制偏移量比自己小的时候，就会发送从服务器确实的数据过来。

通过`INFO replication`命令可以查看配置中的lag值，lag值的含义是从服务器最后一次发送`REPLCONF`过了多少秒。

另外还可以通过配置文件配置下面两个属性
```
min-slaves-to-write 3
min-slaves-max-lag 10
```
这两个配置的含义是：当从服务器小于3个或3个从服务器的延迟时间≥10秒时，主服务器将拒绝执行写命令。
这是为了防止从服务器不可达。